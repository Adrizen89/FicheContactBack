name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Job 1: Tests et qualit√© du code
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: fichecontact_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/fichecontact_test
        ENVIRONMENT: test
        DEBUG: False
      run: |
        pytest tests/ -v --cov=contact_fiche --cov=infrastructure --cov-report=xml --cov-report=term

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage.xml
        fail_ci_if_error: false

    - name: Type checking with mypy
      run: |
        mypy contact_fiche/ infrastructure/ --ignore-missing-imports

  # Job 2: Linting et formatage
  lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 isort

    - name: Check code formatting with Black
      run: |
        black --check contact_fiche/ infrastructure/ tests/

    - name: Check imports with isort
      run: |
        isort --check-only contact_fiche/ infrastructure/ tests/

    - name: Lint with flake8
      run: |
        flake8 contact_fiche/ infrastructure/ --max-line-length=120 --extend-ignore=E203,W503

  # Job 3: Build et Push Docker image
  build-and-push:
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # Job 4: Security scan
  security:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install safety
      run: |
        python -m pip install --upgrade pip
        pip install safety

    - name: Check dependencies for vulnerabilities
      run: |
        safety check --file requirements.txt --continue-on-error

  # Job 5: D√©ploiement sur VPS Hostinger
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to VPS Hostinger
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        envs: GITHUB_REPOSITORY,DB_PASSWORD,IMAGE_TAG
        script: |
          # Se placer dans le dossier de l'app
          mkdir -p ~/apps/fiche-api
          cd ~/apps/fiche-api

          # T√©l√©charger les fichiers de configuration depuis GitHub
          echo "üì• T√©l√©chargement des fichiers de configuration..."

          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H 'Accept: application/vnd.github.v3.raw' \
               -o docker-compose.production.yml \
               -L https://api.github.com/repos/${{ github.repository }}/contents/docker-compose.production.yml

          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H 'Accept: application/vnd.github.v3.raw' \
               -o deploy.sh \
               -L https://api.github.com/repos/${{ github.repository }}/contents/deploy.sh

          # T√©l√©charger les migrations si elles existent
          mkdir -p migrations
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H 'Accept: application/vnd.github.v3.raw' \
               -o migrations/001_remove_obsolete_columns.sql \
               -L https://api.github.com/repos/${{ github.repository }}/contents/migrations/001_remove_obsolete_columns.sql || true

          chmod +x deploy.sh

          # Login au GitHub Container Registry
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          # D√©finir les variables d'environnement pour le d√©ploiement
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export GITHUB_REPOSITORY="${{ github.repository }}"
          export IMAGE_TAG="latest"

          # Ex√©cuter le d√©ploiement
          ./deploy.sh latest

    - name: Health Check
      run: |
        echo "‚è≥ Attente de 30 secondes pour le d√©marrage de l'API..."
        sleep 30

        echo "üîç V√©rification de l'API..."
        curl -f http://${{ secrets.VPS_HOST }}:8000/ || (echo "‚ùå Health check √©chou√©" && exit 1)

        echo "‚úÖ API op√©rationnelle !"

    - name: Notify deployment success
      if: success()
      run: |
        echo "üéâ D√©ploiement r√©ussi sur le VPS Hostinger !"
        echo "üìç URL: http://${{ secrets.VPS_HOST }}:8000"
        echo "üìö Swagger: http://${{ secrets.VPS_HOST }}:8000/docs"
